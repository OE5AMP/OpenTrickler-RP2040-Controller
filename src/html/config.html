<!DOCTYPE html>
<html>
<head>
  <title>Settings</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css">
  <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
  <style>
    body {
      background-color: #f2f2f2;
      padding: 20px;
    }
    
    h1 {
      color: #333;
      text-align: center;
    }
    
    .container {
      display: flex;
    }
    
    .nav-column {
      flex: 1;
      padding-right: 20px;
    }
    
    .config-column {
      flex: 2;
    }
    
    .nav-link {
      display: block;
      padding: 10px;
      background-color: #fff;
      border-radius: 5px;
      margin-bottom: 10px;
      color: #333;
      text-decoration: none;
    }
    
    .nav-link:hover {
      background-color: #f5f5f5;
    }
    
    .nav-link.active {
      background-color: #4CAF50;
      color: #fff;
    }
    
    .form-group label {
      color: #555;
    }
    
    .form-group input,
    .form-group select {
      width: 100%;
    }
    
    .btn-primary {
      background-color: #4CAF50;
      border-color: #4CAF50;
    }
    
    .label {
      color: white;
      padding: 2px;
    }
    .success {background-color: #04AA6D;} /* Green */
    .info {background-color: #2196F3;} /* Blue */
    .warning {background-color: #ff9800;} /* Orange */
    .danger {background-color: #f44336;} /* Red */
    .other {background-color: #e7e7e7; color: black;} /* Gray */
  </style>
</head>
<body>
  <h1>Open Trickler Settings</h1>
  
  <div class="container">
    <div class="nav-column">
      <a class="nav-link active" href="#scale_config">Scale</a>
      <a class="nav-link" href="#charge_mode_config">Charge Mode</a>
      <a class="nav-link" href="#wireless_config">Wireless</a>
      <a class="nav-link" href="#coarse_motor_config">Coarse Motor</a>
      <a class="nav-link" href="#fine_motor_config">Fine Motor</a>
      <a class="nav-link" href="#system_control">System Control</a>
      <!-- Add more categories as needed -->
    </div>
    
    <div class="config-column">

      <!-- Scale Config -->
      <div id="scale_config" class="config-section">
        <h2>Scale Configuration</h2>
        <form class="config-form" id="scale_config-form">
          <div class="form-group">
            <label for="unit">Scale Unit:</label>
            <select class="form-control" id="unit" name="unit">
              <option value="grain">Grain</option>
              <option value="gram">Gram</option>
            </select>
          </div>
                    
          <button type="submit" class="btn btn-primary" data-api="/scale_config">Apply Scale Settings</button>
        </form>
      </div>
      
      <!-- Charge Mode Config -->
      <div id="charge_mode_config" class="config-section" style="display: none;">
        <h2>Charge Mode Configuration</h2>
        <form class="config-form" id="charge_mode_config-form">
          <div class="form-group">
            <label for="coarse_kp">Coarse Kp:</label>
            <input type="number" class="form-control" id="coarse_kp" name="coarse_kp" step="0.001">
          </div>

          <div class="form-group">
            <label for="coarse_ki">Coarse Ki:</label>
            <input type="number" class="form-control" id="coarse_ki" name="coarse_ki" step="0.001">
          </div>
          
          <div class="form-group">
            <label for="coarse_kd">Coarse Kd:</label>
            <input type="number" class="form-control" id="coarse_kd" name="coarse_kd" step="0.001">
          </div>

          <div class="form-group">
            <label for="fine_kd">Coarse Kd:</label>
            <input type="number" class="form-control" id="fine_kd" name="fine_kd" step="0.001">
          </div>

          <div class="form-group">
            <label for="fine_ki">Coarse Kd:</label>
            <input type="number" class="form-control" id="fine_ki" name="fine_ki" step="0.001">
          </div>

          <div class="form-group">
            <label for="fine_kd">Coarse Kd:</label>
            <input type="number" class="form-control" id="fine_kd" name="fine_kd" step="0.001">
          </div>
                    
          <button type="submit" class="btn btn-primary" data-api="/charge_mode_config">Apply Charge Mode Settings</button>
        </form>
      </div>
      
      <!-- Wireless Config -->
      <div id="wireless_config" class="config-section" style="display: none;">
        <h2>Wireless Configuration</h2>
        <form class="config-form" id="wireless_config-form">
          <div class="form-group">
            <label for="ssid">WiFi SSID:</label>
            <input type="text" class="form-control" id="ssid" name="ssid">
          </div>
          
          <div class="form-group">
            <label for="pw">WiFi Password:</label>
            <input type="password" class="form-control" id="pw" name="pw">
          </div>

          <div class="form-group">
            <label for="auth">WiFi Authentication Method:</label>
            <select class="form-control" id="auth" name="auth">
              <option value="CYW43_AUTH_OPEN">None</option>
              <option value="CYW43_AUTH_WPA_TKIP_PSK">WPA-TKIP</option>
              <option value="CYW43_AUTH_WPA2_AES_PSK">WPA2-AES</option>
              <option value="CYW43_AUTH_WPA2_MIXED_PSK">WPA2-MIXED</option>
            </select>
          </div>

          <div class="form-group">
            <label for="configured">Use WiFi:</label>
            <select class="form-control" id="configured" name="configured">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
                    
          <button type="submit" class="btn btn-primary" data-api="/wireless_config">Apply Wireless Settings</button>
        </form>
      </div>

      <!-- Motor Config (Coarse) -->
      <div id="coarse_motor_config" class="config-section" style="display: none;">
        <h2>Coarse Motor Configuration</h2>
        <form class="config-form" id="coarse_motor_config-form">
          <div class="form-group">
            <label for="accel">Angular Acceleration (rps/s):</label>
            <input type="number" class="form-control" id="accel" name="accel" step="1">
          </div>

          <div class="form-group">
            <label for="full_steps_per_rotation">Full Steps per Rotation:</label>
            <select class="form-control" id="full_steps_per_rotation" name="full_steps_per_rotation">
              <option value="200">200</option>
              <option value="400">400</option>
            </select>
          </div>

          <div class="form-group">
            <label for="current_ma">Current (ma):</label>
            <input type="number" class="form-control" id="current_ma" name="current_ma" step="1">
          </div>

          <div class="form-group">
            <label for="microsteps">Microsteps:</label>
            <select class="form-control" id="microsteps" name="microsteps">
              <option value="16">16</option>
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128">128</option>
              <option value="256">256</option>
            </select>
          </div>

          <div class="form-group">
            <label for="max_speed_rps">Max Speed (rps):</label>
            <input type="number" class="form-control" id="max_speed_rps" name="max_speed_rps" step="0.1">
          </div>

          <div class="form-group">
            <label for="r_sense">Current Sensing Resistor (mOhm):</label>
            <input type="number" class="form-control" id="r_sense" name="r_sense" step="1">
          </div>

          <div class="form-group">
            <label for="inv_en">Inverted Enable Pin:</label>
            <select class="form-control" id="inv_en" name="inv_en">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="form-group">
            <label for="inv_dir">Inverted Step Direction Pin:</label>
            <select class="form-control" id="inv_dir" name="inv_dir">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary" data-api="/coarse_motor_config">Apply Coarse Motor Settings</button>
        </form>
      </div>

      <!-- Motor Config (Fine) -->
      <div id="fine_motor_config" class="config-section" style="display: none;">
        <h2>Fine Motor Configuration</h2>
        <form class="config-form" id="fine_motor_config-form">
          <div class="form-group">
            <label for="accel">Angular Acceleration (rps/s):</label>
            <input type="number" class="form-control" id="accel" name="accel" step="1">
          </div>

          <div class="form-group">
            <label for="full_steps_per_rotation">Full Steps per Rotation:</label>
            <select class="form-control" id="full_steps_per_rotation" name="full_steps_per_rotation">
              <option value="200">200</option>
              <option value="400">400</option>
            </select>
          </div>

          <div class="form-group">
            <label for="current_ma">Current (ma):</label>
            <input type="number" class="form-control" id="current_ma" name="current_ma" step="1">
          </div>

          <div class="form-group">
            <label for="microsteps">Microsteps:</label>
            <select class="form-control" id="microsteps" name="microsteps">
              <option value="16">16</option>
              <option value="32">32</option>
              <option value="64">64</option>
              <option value="128">128</option>
              <option value="256">256</option>
            </select>
          </div>

          <div class="form-group">
            <label for="max_speed_rps">Max Speed (rps):</label>
            <input type="number" class="form-control" id="max_speed_rps" name="max_speed_rps" step="0.1">
          </div>

          <div class="form-group">
            <label for="r_sense">Current Sensing Resistor (mOhm):</label>
            <input type="number" class="form-control" id="r_sense" name="r_sense" step="1">
          </div>

          <div class="form-group">
            <label for="inv_en">Inverted Enable Pin:</label>
            <select class="form-control" id="inv_en" name="inv_en">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="form-group">
            <label for="inv_dir">Inverted Step Direction Pin:</label>
            <select class="form-control" id="inv_dir" name="inv_dir">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <button type="submit" class="btn btn-primary" data-api="/fine_motor_config">Apply Fine Motor Settings</button>
        </form>
      </div>


      <!-- EEPROM Config -->
      <div id="system_control" class="config-section" style="display: none;">
        <h2>System Control</h2>
        <form class="config-form" id="system_control-form">
          <div class="form-group">
            <label for="unique_id">Unique ID:</label>
            <!-- Don't show unique id when submit -->
            <input type="text" class="form-control" id="unique_id" name="unique_id" disabled="disabled" readonly>
          </div>

          <div class="form-group">
            <label for="save_to_eeprom">Save to EEPROM:</label>
            <select class="form-control" id="save_to_eeprom" name="save_to_eeprom">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="form-group">
            <label for="software_reset">Reboot:</label>
            <select class="form-control" id="software_reset" name="software_reset">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>

          <div class="form-group">
            <span class="label warning">Warning</span>
            <label for="erase_eeprom"> Erase EEPROM:</label>
            <select class="form-control" id="erase_eeprom" name="erase_eeprom">
              <option value="true">Yes</option>
              <option value="false">No</option>
            </select>
          </div>
          
                    
          <button type="submit" class="btn btn-primary" data-api="/system_control">Apply System Control</button>
        </form>
      </div>
      
      <!-- Add more configuration sections for additional categories -->
    </div>
  </div>

  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>
  <script>
    $(document).ready(function() {
      // Calls the populate when landing on the page
      var firstCategory = $('.nav-link').first().attr('href');
      populateConfigOptions(firstCategory);

      // Populate options when switching categories
      $('.nav-link').click(function(e) {
        e.preventDefault();
        var target = $(this).attr('href');
        $('.nav-link').removeClass('active');
        $(this).addClass('active');
        $('.config-section').hide();
        $(target).show();
        populateConfigOptions(target); 
      });

      $('.config-form').submit(function(e) {
        e.preventDefault();
        var formData = $(this).serialize();
        var apiUrl = $(this).find('button').data('api');
        saveCategorySettings(formData, apiUrl);
      });

      function populateConfigOptions(target) {
        var category = target.substr(1); // Remove the "#" character from the target
        var apiUrl = '/rest/' + category;

        $.ajax({
          url: apiUrl,
          dataType: 'json',
          method: 'GET',
          success: function(response) {
            populateOptions(category, response);
          },
          error: function(xhr, status, error) {
            console.error('An error occurred while retrieving options:', error);
          }
        });
      }

      function populateOptions(category, options) {
        var form = $('#' + category + '-form');

        for (var key in options) {
          var value = options[key];
          // Find corresponding form, clear it first
          var form_input = form.find('[name="' + key + '"]');
          form_input.val(String(value))
        }
      }

      function saveCategorySettings(formData, apiUrl) {
        var url = '/rest' + apiUrl;

        // Remove empty parameters from formData
        var filtered_params = formData.split('&').filter(function(param) {
          var value = param.split('=')[1];
          return value && value.trim() !== '';
        }).join('&');

        $.ajax({
          url: url,
          method: 'GET',
          data: filtered_params,
          success: function(response) {
            console.log('Settings saved successfully!');
          },
          error: function(xhr, status, error) {
            console.error('An error occurred while saving settings:', error);
          }
        });
      }
    });
  </script>
</body>
</html>
